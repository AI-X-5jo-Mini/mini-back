import openai
import os
from dotenv import load_dotenv

# .env 파일에서 API 키 불러오기
load_dotenv()
api_key = os.getenv("OPENAI_API_KEY")

def remove_duplicate_lines(text):
    lines = text.split("\n")
    seen = set()
    filtered_lines = []
    
    for line in lines:
        if line.strip() not in seen:
            seen.add(line.strip())
            filtered_lines.append(line)

    return "\n".join(filtered_lines)

def get_face_analysis(features, person_name="이 사람"):
    """GPT를 사용한 개별 관상 분석"""
    prompt = f"""
    {person_name}의 얼굴 특징 분석:
    - 이마 넓이: {features['forehead_width']}
    - 이마 높이: {features['forehead_height']}
    - 눈 크기: {features['eye_size']}
    - 눈 사이 거리: {features['eye_distance']}
    - 코 길이: {features['nose_length']}
    - 콧볼 넓이: {features['nose_width']}
    - 입 길이: {features['mouth_width']}
    - 입술 두께: {features['lip_thickness']}
    - 광대뼈 너비: {features['cheekbone_width']}
    - 턱 길이: {features['jaw_length']}
    - 미간 거리: {features['brow_distance']}

    위 정보를 바탕으로 한국 전통 관상학적 해석을 제공해줘.
    """

    client = openai.OpenAI(api_key=api_key)

    response = client.chat.completions.create(
        model="gpt-4o-mini",
        messages=[{"role": "user", "content": prompt}]
    )

    return remove_duplicate_lines(response.choices[0].message.content)


def get_compatibility_analysis(features1, features2, name1="첫 번째 사람", name2="두 번째 사람"):
    """GPT를 사용한 두 사람의 관상 궁합 분석 및 점수 출력"""
    prompt = f"""
    너는 우리나라 최고의 관상가야.
    다음 두 사람의 얼굴 특징을 비교하고 관상학적으로 궁합을 분석해줘.

    {name1}의 얼굴 특징:
    - 이마 넓이: {features1['forehead_width']}
    - 이마 높이: {features1['forehead_height']}
    - 눈 크기: {features1['eye_size']}
    - 눈 사이 거리: {features1['eye_distance']}
    - 코 길이: {features1['nose_length']}
    - 콧볼 넓이: {features1['nose_width']}
    - 입 길이: {features1['mouth_width']}
    - 입술 두께: {features1['lip_thickness']}
    - 광대뼈 너비: {features1['cheekbone_width']}
    - 턱 길이: {features1['jaw_length']}
    - 미간 거리: {features1['brow_distance']}

    {name2}의 얼굴 특징:
    - 이마 넓이: {features2['forehead_width']}
    - 이마 높이: {features2['forehead_height']}
    - 눈 크기: {features2['eye_size']}
    - 눈 사이 거리: {features2['eye_distance']}
    - 코 길이: {features2['nose_length']}
    - 콧볼 넓이: {features2['nose_width']}
    - 입 길이: {features2['mouth_width']}
    - 입술 두께: {features2['lip_thickness']}
    - 광대뼈 너비: {features2['cheekbone_width']}
    - 턱 길이: {features2['jaw_length']}
    - 미간 거리: {features2['brow_distance']}


    관상 궁합의 근거
    1. 얼굴형 궁합 (성격적 조화)
    얼굴형은 성격과 리더십 스타일을 결정하는 중요한 요소이다.
    비슷한 얼굴형을 가진 사람들은 서로의 성향을 잘 이해하고 공감할 수 있다.
    보완적인 얼굴형을 가진 사람들은 서로의 부족한 부분을 채워주는 관계가 된다.
    반대로, 너무 비슷하거나 극단적으로 다른 얼굴형을 가진 경우 의견 충돌이 발생할 가능성이 높다.

    얼굴형별 궁합 특징:
    둥근 얼굴은 온화하고 친화적이며 감성적인 성향을 가지므로, 갸름한 얼굴과 잘 어울린다.
    각진 얼굴은 강한 추진력을 가지며 리더형 성향이 강하기 때문에 둥근 얼굴과 만나 감성적 균형을 맞출 때 좋은 궁합이 된다.
    갸름한 얼굴은 분석적이고 신중한 성향을 가지고 있어 둥근 얼굴과 조화를 이룰 수 있다.
    네모난 얼굴은 현실적이고 논리적인 성향을 가지고 있어 둥근 얼굴과 조화를 이루기 좋으며, 네모난 얼굴끼리는 주도권 다툼이 발생할 수 있다.
    긴 얼굴은 계획적이고 인내심이 강한 성향이므로 갸름한 얼굴과 함께 있을 때 좋은 궁합이 형성된다.

    2. 눈 크기 & 간격 (감성적 조화)
    눈은 감정 표현력과 대인관계 성향을 나타낸다.
    눈 크기가 비슷한 두 사람은 감정 교류가 원활하며 서로의 감정을 쉽게 이해할 수 있다.
    눈 크기가 다른 경우 한쪽은 감정적이고 한쪽은 현실적일 수 있어 조정이 필요하다.
    눈 사이 간격이 적당해야 서로에 대한 신뢰가 높으며, 너무 가까우면 의심이 많고 오해가 생길 가능성이 높다.

    눈 유형별 궁합 특징:
    큰 눈을 가진 사람은 감수성이 풍부하고 감정적인 성향을 보이므로, 작은 눈을 가진 현실적인 사람과 균형을 맞출 때 좋은 궁합이 된다.
    작은 눈을 가진 사람은 신중하고 현실적이므로, 감정 표현이 풍부한 큰 눈을 가진 사람과 함께 있을 때 감정 균형이 맞춰진다.
    눈 사이 거리가 넓은 사람은 개방적이고 자유로운 성향을 가지며, 적당한 거리의 눈을 가진 사람과 조화를 이룰 수 있다.
    눈 사이 거리가 좁은 사람은 집중력이 강하지만 의심이 많을 수 있어, 너무 가까운 눈을 가진 사람과 함께 있을 경우 다툼이 발생할 가능성이 있다.

    3. 코 크기 & 길이 (재물운 & 리더십)
    코는 리더십과 추진력, 재물운을 나타낸다.
    코 크기가 크면 야망이 크고 추진력이 강한 반면, 코 크기가 작으면 현실적이며 조용한 성향을 가진다.
    코 크기가 비슷한 두 사람은 협력과 조화를 이루기가 쉽다.
    한쪽이 코가 크고 한쪽이 작으면 리더십과 역할 분담에서 갈등이 발생할 가능성이 있다.

    코 유형별 궁합 특징:
    큰 코를 가진 사람은 리더십이 강하고 야망이 많기 때문에, 작은 코를 가진 현실적이고 신중한 사람과 함께 있을 때 균형이 맞는다.
    작은 코를 가진 사람은 현실적이고 조용한 성향을 가지며, 추진력이 강한 큰 코를 가진 사람과 조화를 이룰 수 있다.
    긴 코를 가진 사람은 계획적이며 재물운이 강한 성향이므로, 즉흥적인 성향의 짧은 코를 가진 사람과 함께 있을 때 보완적인 관계가 형성된다.
    짧은 코를 가진 사람은 감정적이고 즉흥적인 성향이 있어, 신중한 긴 코를 가진 사람과 만나면 조화로운 관계가 될 수 있다.

    4. 입 크기 & 입술 두께 (대화 궁합 & 애정운)
    입은 말하는 스타일과 감정 표현 능력을 나타낸다.
    입 크기가 비슷한 두 사람은 대화가 원활하게 이루어진다.
    입 크기가 다르면 대화 방식이 다를 가능성이 있어 조정이 필요하다.
    입술이 두꺼우면 감정 표현이 풍부하며, 얇으면 감정을 잘 드러내지 않는 성향을 보인다.

    입 유형별 궁합 특징:
    큰 입을 가진 사람은 사교적이고 적극적인 성향을 가지므로, 신중하고 조용한 작은 입을 가진 사람과 함께 있을 때 좋은 궁합이 된다.
    작은 입을 가진 사람은 조용하고 신중한 성향이 있으며, 적극적인 성향의 큰 입을 가진 사람과 함께 있을 때 서로의 성향을 보완할 수 있다.
    윗입술이 두꺼운 사람은 애정 표현이 적극적인 경향이 있으며, 아랫입술이 두꺼운 사람과 좋은 궁합을 이루는 경우가 많다.
    아랫입술이 두꺼운 사람은 자기주장이 강한 편이므로, 감성적인 윗입술이 두꺼운 사람과 함께 있을 때 보완적인 관계가 형성된다.

    5. 귀 모양 (성공운 & 성격 안정성)
    귀는 운명과 장기적인 삶의 흐름을 의미한다.
    큰 귀는 리더십과 영향력을 상징하며, 작은 귀는 신중하고 내성적인 성향을 나타낸다.
    귓볼이 두꺼우면 재물운이 강한 경우가 많으며, 귓볼이 얇으면 민감하고 예민한 성향을 보일 가능성이 있다.

    귀 유형별 궁합 특징:
    큰 귀를 가진 사람은 통솔력이 강하고 지휘력이 뛰어나므로, 조용하고 신중한 작은 귀를 가진 사람과 함께 있을 때 좋은 궁합을 이룬다.
    작은 귀를 가진 사람은 내성적인 성향이 강하며, 강한 리더십을 가진 큰 귀를 가진 사람과 함께 있을 때 안정감을 느낄 수 있다.
    귓볼이 두꺼운 사람은 재물운이 강한 편이며, 귓볼이 작은 귀를 가진 사람과 조화를 이루기 좋다.
    귓볼이 얇은 사람은 예민한 성향을 가질 수 있어, 귓볼이 두꺼운 사람과 함께 있을 때 안정적인 관계를 형성할 가능성이 높다.

    6. 눈썹 모양 (성격 & 대인관계)
    눈썹은 성격과 인간관계를 나타낸다.
    일자 눈썹은 추진력이 강한 성향이며, 초승달 눈썹은 감성적이고 부드러운 성향을 나타낸다.

    눈썹 유형별 궁합 특징:
    일자 눈썹을 가진 사람은 강한 추진력을 가지므로, 감성적이고 부드러운 성향의 초승달 눈썹을 가진 사람과 함께 있을 때 좋은 균형이 형성된다.
    초승달 눈썹을 가진 사람은 감성적이고 조화로운 성향을 가지며, 강한 추진력을 가진 일자 눈썹을 가진 사람과 만나면 조화로운 관계를 이루게 된다.

    위의 정보를 바탕으로
    1. 두 사람의 얼굴 특징을 분석하여 관상학적 성향을 평가해줘.
    2. 얼굴형, 눈, 코, 입, 귀, 눈썹, 이마를 기반으로 전통 관상학적으로 어떤 성격과 성향을 가졌는지 설명해줘.
    3. 얼굴 특징을 기반으로 두 사람의 연애 스타일과 결혼 궁합을 분석해줘.
    4. 두 사람의 얼굴형과 재물운, 직업적 성향을 평가해줘.
    5. 궁합 점수를 100점 만점 기준으로 평가하고, 다음 5가지 요소별로 세부 점수를 제공해줘.
    - 감성적 조화
    - 성격 조화
    - 대화 궁합
    - 재물운 조화
    - 장기적 관계 안정성

    예시: A와 B의 관상 궁합 분석
    A는 둥근 얼굴을 가지고 있으며, 눈은 크고 간격이 넓고 눈썹은 일자 눈썹이다. 코는 작고 길이가 짧고 입은 크고 두꺼우며, 입술은 두꺼운 편이다. 귀는 작고 두꺼우며,  이마는 넓고 높다.
    B는 네모난 얼굴을 가지고 있으며, 눈은 작고 간격이 좁고 눈썹은 초승달 눈썹이다. 코는 크고 길이가 긴 편이고 입은 작고 얇으며, 입술은 얇은 편이다. 귀는 크고 두꺼우며, 이마는 넓고 높다.
    A와 B의 관상 궁합 분석 결과:
    A는 감성적이고 부드러운 성향을 가지고 있으며, B는 강한 추진력을 가지고 있다. 두 사람은 감성적 조화를 이루기 좋은 궁합이다.
    A와 B의 관상 궁합 점수는 감성적 조화 요소가 85점, 성격 조화 요소가 90점, 대화 궁합 요소가 80점, 재물운 조화 요소가 95점, 장기적 관계 안정성 요소가 88점으로
    둘의 관상 궁합 점수는 총 85점이다.
    """

    client = openai.OpenAI(api_key=api_key)

    response = client.chat.completions.create(
        model="gpt-4o-mini",
        messages=[{"role": "user", "content": prompt}]
    )

    return remove_duplicate_lines(response.choices[0].message.content)

