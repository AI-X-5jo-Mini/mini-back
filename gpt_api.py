import openai
import os
from dotenv import load_dotenv

# .env íŒŒì¼ì—ì„œ API í‚¤ ë¶ˆëŸ¬ì˜¤ê¸°
load_dotenv()
api_key = os.getenv("OPENAI_API_KEY")

def remove_duplicate_lines(text):
    lines = text.split("\n")
    seen = set()
    filtered_lines = []
    
    for line in lines:
        if line.strip() not in seen:
            seen.add(line.strip())
            filtered_lines.append(line)

    return "\n".join(filtered_lines)

def get_face_analysis(features, person_name="ì´ ì‚¬ëŒ"):
    """GPTë¥¼ ì‚¬ìš©í•œ ê°œë³„ ê´€ìƒ ë¶„ì„"""
    prompt = f"""
    {person_name}ì˜ ì–¼êµ´ íŠ¹ì§• ë¶„ì„:
    - ì´ë§ˆ ë„“ì´: {features['forehead_width']}
    - ì´ë§ˆ ë†’ì´: {features['forehead_height']}
    - ëˆˆ í¬ê¸°: {features['eye_size']}
    - ëˆˆ ì‚¬ì´ ê±°ë¦¬: {features['eye_distance']}
    - ì½” ê¸¸ì´: {features['nose_length']}
    - ì½§ë³¼ ë„“ì´: {features['nose_width']}
    - ì… ê¸¸ì´: {features['mouth_width']}
    - ì…ìˆ  ë‘ê»˜: {features['lip_thickness']}
    - ê´‘ëŒ€ë¼ˆ ë„ˆë¹„: {features['cheekbone_width']}
    - í„± ê¸¸ì´: {features['jaw_length']}
    - ë¯¸ê°„ ê±°ë¦¬: {features['brow_distance']}

    ìœ„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ í•œêµ­ ì „í†µ ê´€ìƒí•™ì  í•´ì„ì„ ì œê³µí•´ì¤˜.
    """

    client = openai.OpenAI(api_key=api_key)

    response = client.chat.completions.create(
        model="gpt-4o",
        messages=[{"role": "user", "content": prompt}]
    )

    return remove_duplicate_lines(response.choices[0].message.content)


def get_compatibility_analysis(features1, features2, name1="ì²« ë²ˆì§¸ ì‚¬ëŒ", name2="ë‘ ë²ˆì§¸ ì‚¬ëŒ"):
    """GPTë¥¼ ì‚¬ìš©í•œ ë‘ ì‚¬ëŒì˜ ê´€ìƒ ê¶í•© ë¶„ì„ ë° ì ìˆ˜ ì¶œë ¥"""
    prompt = f"""
    ë‹¹ì‹ ì€ í•œêµ­ ì „í†µ ê´€ìƒí•™ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.  
ë‹¤ìŒ ë‘ ì‚¬ëŒì˜ ì–¼êµ´ íŠ¹ì§•ì„ ê¸°ë°˜ìœ¼ë¡œ **ê°ê°ì˜ ê´€ìƒ í•´ì„**ì„ ì œê³µí•œ í›„, ë‘ ì‚¬ëŒì˜ **ê¶í•© ë¶„ì„ ë° ì ìˆ˜ í‰ê°€(100ì  ë§Œì )**ë¥¼ ìˆ˜í–‰í•˜ì„¸ìš”.  

## ğŸ”¹ ì²« ë²ˆì§¸ ì‚¬ëŒ: {name1}
- ì´ë§ˆ ë„“ì´: {features1['forehead_width']}
- ì´ë§ˆ ë†’ì´: {features1['forehead_height']}
- ëˆˆ í¬ê¸°: {features1['eye_size']}
- ëˆˆ ì‚¬ì´ ê±°ë¦¬: {features1['eye_distance']}
- ì½” ê¸¸ì´: {features1['nose_length']}
- ì½§ë³¼ ë„“ì´: {features1['nose_width']}
- ì… ê¸¸ì´: {features1['mouth_width']}
- ì…ìˆ  ë‘ê»˜: {features1['lip_thickness']}
- ê´‘ëŒ€ë¼ˆ ë„ˆë¹„: {features1['cheekbone_width']}
- í„± ê¸¸ì´: {features1['jaw_length']}
- ë¯¸ê°„ ê±°ë¦¬: {features1['brow_distance']}

## ğŸ”¹ ë‘ ë²ˆì§¸ ì‚¬ëŒ: {name2}
- ì´ë§ˆ ë„“ì´: {features2['forehead_width']}
- ì´ë§ˆ ë†’ì´: {features2['forehead_height']}
- ëˆˆ í¬ê¸°: {features2['eye_size']}
- ëˆˆ ì‚¬ì´ ê±°ë¦¬: {features2['eye_distance']}
- ì½” ê¸¸ì´: {features2['nose_length']}
- ì½§ë³¼ ë„“ì´: {features2['nose_width']}
- ì… ê¸¸ì´: {features2['mouth_width']}
- ì…ìˆ  ë‘ê»˜: {features2['lip_thickness']}
- ê´‘ëŒ€ë¼ˆ ë„ˆë¹„: {features2['cheekbone_width']}
- í„± ê¸¸ì´: {features2['jaw_length']}
- ë¯¸ê°„ ê±°ë¦¬: {features2['brow_distance']}

---

## ğŸ” **1. ê°œë³„ ê´€ìƒ ë¶„ì„**
ê° ì‚¬ëŒì˜ ì–¼êµ´ íŠ¹ì§•ì„ ë°”íƒ•ìœ¼ë¡œ **í•œêµ­ ì „í†µ ê´€ìƒí•™**ì„ ì ìš©í•˜ì—¬ ë¶„ì„ì„ ìˆ˜í–‰í•˜ì„¸ìš”.  
ë‹¤ìŒ ìš”ì†Œë¥¼ ê³ ë ¤í•˜ì—¬ ì„±ê²©ê³¼ ìš´ëª…ì„ í‰ê°€í•˜ì„¸ìš”:

- **ì´ë§ˆ:** ì´ë§ˆì˜ ë„“ì´ì™€ ë†’ì´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì§€ëŠ¥, ì„±í–¥ ë° ì‚¬íšŒì  ì„±ê³µ ê°€ëŠ¥ì„± í‰ê°€  
- **ëˆˆ:** ëˆˆ í¬ê¸°ì™€ ê°„ê²©ì„ ë¶„ì„í•˜ì—¬ ê°ì • í‘œí˜„ë ¥ ë° ëŒ€ì¸ ê´€ê³„ ê²½í–¥ ë¶„ì„  
- **ì½”:** ì½”ì˜ í¬ê¸°ì™€ ê¸¸ì´ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë¦¬ë”ì‹­ê³¼ ì¬ë¬¼ìš´ í‰ê°€  
- **ì…:** ì…ì˜ í¬ê¸°ì™€ ì…ìˆ  ë‘ê»˜ë¥¼ ë¶„ì„í•˜ì—¬ ì–¸ì–´ í‘œí˜„ ëŠ¥ë ¥ ë° ì„±í–¥ í‰ê°€  
- **í„±:** í„±ì˜ í˜•íƒœë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê²°ë‹¨ë ¥ê³¼ ì„±í–¥ í‰ê°€  

### âœ¨ **ì¶œë ¥ í˜•ì‹ ì˜ˆì‹œ**
---
ğŸ”® **ì²« ë²ˆì§¸ ì‚¬ëŒì˜ ê´€ìƒ ë¶„ì„**
- **ì„±ê²©:** 00í•œ ì„±í–¥ì„ ê°€ì§  
- **ìš´ëª…:** 00í•œ ì‚¶ì„ ì‚´ ê°€ëŠ¥ì„±ì´ ë†’ìŒ  
- **ì¬ë¬¼ìš´:** 00í•œ ê²½í–¥ì´ ìˆìœ¼ë©°, ê²½ì œì ìœ¼ë¡œ 00í•  ê°€ëŠ¥ì„±ì´ í¼  
- **ì—°ì• ìš´:** 00í•œ ì—°ì•  ìŠ¤íƒ€ì¼ì„ ê°€ì§  
- **ì‚¬íšŒì  ì¸ê°„ê´€ê³„:** 00í•œ íŠ¹ì§•ìœ¼ë¡œ ì¸í•´ ì£¼ë³€ ì‚¬ëŒë“¤ê³¼ 00í•œ ê´€ê³„ë¥¼ í˜•ì„±í•¨  

ğŸ”® **ë‘ ë²ˆì§¸ ì‚¬ëŒì˜ ê´€ìƒ ë¶„ì„**
- **ì„±ê²©:** 00í•œ ì„±í–¥ì„ ê°€ì§  
- **ìš´ëª…:** 00í•œ ì‚¶ì„ ì‚´ ê°€ëŠ¥ì„±ì´ ë†’ìŒ  
- **ì¬ë¬¼ìš´:** 00í•œ ê²½í–¥ì´ ìˆìœ¼ë©°, ê²½ì œì ìœ¼ë¡œ 00í•  ê°€ëŠ¥ì„±ì´ í¼  
- **ì—°ì• ìš´:** 00í•œ ì—°ì•  ìŠ¤íƒ€ì¼ì„ ê°€ì§  
- **ì‚¬íšŒì  ì¸ê°„ê´€ê³„:** 00í•œ íŠ¹ì§•ìœ¼ë¡œ ì¸í•´ ì£¼ë³€ ì‚¬ëŒë“¤ê³¼ 00í•œ ê´€ê³„ë¥¼ í˜•ì„±í•¨  
---

## ğŸ” **2. ë‘ ì‚¬ëŒì˜ ê¶í•© ë¶„ì„**
ê°ìì˜ ê´€ìƒì„ ë°”íƒ•ìœ¼ë¡œ ê¶í•©ì„ í‰ê°€í•˜ì„¸ìš”.  
ë‹¤ìŒ ê¸°ì¤€ì„ ì ìš©í•˜ì—¬ ê¶í•© ì ìˆ˜ë¥¼ ë§¤ê¸°ê³ , ê·¸ ê·¼ê±°ë¥¼ ì œì‹œí•˜ì„¸ìš”.

### ğŸ“Œ **ê¶í•© í‰ê°€ ê¸°ì¤€**
1. **ì–¼êµ´í˜• ì¡°í™”**
   - ë¹„ìŠ·í•œ ì–¼êµ´í˜• â†’ ì„œë¡œ ì´í•´ë„ê°€ ë†’ìŒ (ì˜ˆ: ë‘¥ê·¼ ì–¼êµ´ & ë‘¥ê·¼ ì–¼êµ´)
   - ë³´ì™„ì ì¸ ì–¼êµ´í˜• â†’ ìƒí˜¸ ë³´ì™„ì ì¸ ê´€ê³„ (ì˜ˆ: ê°¸ë¦„í•œ ì–¼êµ´ & ë‘¥ê·¼ ì–¼êµ´)
   - ë°˜ëŒ€ë˜ëŠ” ì„±í–¥ì˜ ì–¼êµ´í˜• â†’ ì˜ê²¬ ì¶©ëŒ ê°€ëŠ¥ (ì˜ˆ: ê°ì§„ ì–¼êµ´ & ê°ì§„ ì–¼êµ´)

2. **ëˆˆ í¬ê¸° & ê°„ê²©**
   - ëˆˆ í¬ê¸°ê°€ ë¹„ìŠ·í•˜ë©´ ê°ì • êµë¥˜ê°€ ì›í™œí•¨  
   - ëˆˆ ì‚¬ì´ ê±°ë¦¬ê°€ ì ë‹¹í•˜ë©´ ì„œë¡œì— ëŒ€í•œ ì‹ ë¢°ê°€ ë†’ìŒ  
   - ëˆˆì´ ë„ˆë¬´ ê°€ê¹Œìš°ë©´ ì˜¤í•´ê°€ ìƒê¸°ê¸° ì‰¬ì›€  

3. **ì½” í¬ê¸° & ê¸¸ì´**
   - ì½” í¬ê¸°ê°€ ë¹„ìŠ·í•˜ë©´ í˜‘ë ¥ ì˜ë¨  
   - í•œìª½ì´ ì½”ê°€ í¬ê³ , í•œìª½ì´ ì‘ìœ¼ë©´ ê°ˆë“± ê°€ëŠ¥  

4. **ì… í¬ê¸° & ì…ìˆ  ë‘ê»˜**
   - ì… í¬ê¸°ê°€ ë¹„ìŠ·í•˜ë©´ ëŒ€í™”ê°€ ì˜ í†µí•¨  
   - ì…ìˆ ì´ ë‘êº¼ìš°ë©´ ê°ì • í‘œí˜„ì´ í’ë¶€  
   - ì… í¬ê¸° ì°¨ì´ê°€ í¬ë©´ ëŒ€í™” ë°©ì‹ì´ ë‹¤ë¥¼ ê°€ëŠ¥ì„± ìˆìŒ  


    ìœ„ì˜ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë‘ ì‚¬ëŒì˜ ì„±í–¥, ê¶í•©, ê´€ê³„ì˜ ì¡°í™” ë“±ì„ í•œêµ­ ì „í†µ ê´€ìƒí•™ì  ê´€ì ì—ì„œ ë¶„ì„í•˜ê³ , ê¶í•© ì ìˆ˜ë¥¼ 100ì  ë§Œì  ê¸°ì¤€ìœ¼ë¡œ í‰ê°€í•´ì¤˜.
    í•œ ì‚¬ëŒì”© ë¶„ì„ ê²°ê³¼ì™€ ê´€ìƒ ì´ í‰ì„ ì œê³µí•´ì£¼ê³ , ê·¸ ì´í›„ì— ë‘ ì‚¬ëŒì˜ ê´€ìƒ ê¶í•©ì„ ì•Œë ¤ì£¼ë©´ ì¢‹ê² ì–´.
    ë˜í•œ, ì ìˆ˜ì˜ ê·¼ê±°ëŠ” ê´€ìƒ ê¶í•©ì˜ ê·¼ê±°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì„¤ëª…í•´ì¤˜.
    """

    client = openai.OpenAI(api_key=api_key)

    response = client.chat.completions.create(
        model="gpt-4o-mini",
        messages=[{"role": "user", "content": prompt}]
    )


    return remove_duplicate_lines(response.choices[0].message.content)

